<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Renesas BLE 100 ms Logger (Calibrated)</title>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' fill='%232563eb'/%3E%3Ctext x='16' y='21' font-size='18' font-family='Inter,Arial,sans-serif' fill='white' text-anchor='middle'%3ER%3C/text%3E%3C/svg%3E"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4"></script>
  <style>
    :root{color-scheme: light dark;}
    :root{
      --bg:#f7f8fa;
      --fg:#111827; /* slate-900 */
      --muted:#6b7280; /* gray-500 */
      --card:#ffffff;
      --accent:#2563eb; /* refined blue */
      --accent-weak:#e8eefc;
      --border:#e5e7eb; /* gray-200 */
      --shadow:0 1px 2px rgba(0,0,0,.04), 0 6px 20px rgba(0,0,0,.06);
      --radius:12px;
      --series1:#2563eb; /* R1 */
      --series2:#ef4444; /* R2 */
      --series3:#10b981; /* Temp */
      --series4:#8b5cf6; /* pH */
      --grid: rgba(0,0,0,.06);
      --hover-row: rgba(0,0,0,.03);
    }
    /* 手动切换为深色时（覆盖系统偏好） */
    [data-theme="dark"]{
      --bg:#0b1220;
      --fg:#e5e7eb;
      --muted:#9ca3af;
      --card:#0f172a;
      --accent:#60a5fa;
      --accent-weak:rgba(96,165,250,.12);
      --border:#1f2937;
      --shadow:0 0 0 1px rgba(255,255,255,.03), 0 10px 35px rgba(0,0,0,.6);
      --series1:#60a5fa; --series2:#f87171; --series3:#34d399; --series4:#a78bfa;
      --grid: rgba(255,255,255,.08);
      --hover-row: rgba(255,255,255,.03);
    }
    /* 若未手动选择，则默认跟随系统 */
    @media (prefers-color-scheme: dark){
      :root:not([data-theme="light"]){
        --bg:#0b1220;
        --fg:#e5e7eb;
        --muted:#9ca3af;
        --card:#0f172a;
        --accent:#60a5fa;
        --accent-weak:rgba(96,165,250,.12);
        --border:#1f2937;
        --shadow:0 0 0 1px rgba(255,255,255,.03), 0 10px 35px rgba(0,0,0,.6);
        --series1:#60a5fa; --series2:#f87171; --series3:#34d399; --series4:#a78bfa;
        --grid: rgba(255,255,255,.08);
        --hover-row: rgba(255,255,255,.03);
      }
    }

    html,body{height:100%;margin:0}
    body{font-family:'Inter',system-ui,Arial,sans-serif;background:var(--bg);color:var(--fg);-webkit-font-smoothing:antialiased;transition: background .25s ease,color .25s ease;}

    /* 全局布局：让内容在移动端占满视口高度 */
    #app{max-width:1400px;margin:0 auto;padding:24px;display:flex;flex-direction:column;gap:20px;min-height:100dvh;min-height:100svh}

    .app-header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .title{font-size:20px;font-weight:600;letter-spacing:.2px;margin:0}
    .subtitle{color:var(--muted);font-size:13px;margin:0}

    .panel{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);max-hieght:80vh!important;}

    .toolbar{display:grid;grid-template-columns:1fr;gap:12px;padding:16px}
    .toolbar .row{display:flex;flex-wrap:wrap;gap:12px;align-items:end}

    /* Buttons */
    .btn{appearance:none;border:1px solid var(--accent);background:var(--accent);color:#fff;border-radius:10px;padding:10px 14px;font-weight:600;font-size:14px;cursor:pointer;transition:transform .06s ease,opacity .2s ease,background .2s}
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:transparent;color:var(--accent)}
    .btn.secondary:hover{background:var(--accent-weak)}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    /* Icon button for theme toggle */
    .icon-btn{appearance:none;border:1px solid var(--border);background:transparent;color:inherit;border-radius:10px;padding:8px 12px;font-size:16px;line-height:1;cursor:pointer;transition:background .2s,border-color .2s;display:inline-flex;align-items:center;gap:8px}
    .icon-btn:hover{background:var(--accent-weak);}

    /* 浮动按钮（移动端一键显示/隐藏控制区） */
    .fab{position:fixed;right:12px;bottom:12px;z-index:60;border:none;border-radius:9999px;padding:14px 16px;background:var(--accent);color:#fff;box-shadow:var(--shadow);cursor:pointer;display:none}

    /* Fields */
    .field{display:flex;flex-direction:column;gap:6px;min-width:160px}
    .field label{font-size:12px;font-weight:600;color:var(--muted)}
    .input{height:38px;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:transparent;color:inherit;font-size:14px;outline:none;transition:border-color .15s}
    .input:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-weak)}
    .hint{font-size:12px;color:var(--muted)}

    /* Content area */
    #content{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;flex:1;min-height:0;}
    @media (max-width:1100px){#content{grid-template-columns:1fr}}

    /* Mobile tabs (only show on small screens) */
    .mobile-tabs{display:none;gap:8px}
    .mobile-tabs .tab{flex:1;}

    /* Table card */
    .table-card{overflow:hidden;display:flex;flex-direction:column;min-height:0}
    .table-head{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .table-wrap{max-height:70vh!important;overflow:auto;}
    table{border-collapse:collapse;width:100%;min-width:760px;font-size:13px}
    thead th{position:sticky;top:0;background:var(--card);z-index:2;text-align:left;padding:10px;border-bottom:1px solid var(--border);font-weight:600}
    tbody td{padding:10px;border-bottom:1px solid var(--border)}
    tbody tr:hover{background:var(--hover-row)}
    td.num{font-variant-numeric:tabular-nums;text-align:right}
    td.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;letter-spacing:.2px}
    /* sticky first column */
    th.sticky, td.sticky{position:sticky;left:0;background:var(--card);z-index:1}

    /* Charts grid */
    .charts{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width:640px){.charts{grid-template-columns:1fr 1fr}}
    .chart-card{display:flex;flex-direction:column;gap:8px;padding:12px;min-height:260px}
    .chart-title{font-size:13px;color:var(--muted);font-weight:600;padding:0 4px}
    .chart-canvas{height:260px!important;border:1px solid var(--border);border-radius:10px;overflow:hidden;flex:1}
    .chart-canvas canvas{width:100%!important;height:280px!important;display:block}

    /* Respect reduced motion */
    @media (prefers-reduced-motion: reduce){
      *{animation-duration:.01ms!important;animation-iteration-count:1!important;transition-duration:.01ms!important;scroll-behavior:auto!important}
    }

    /* —— 移动端强化：把大部分屏幕让给表格/图表 —— */
    @media (max-width:640px){
      #app{padding:10px}
      .btn,.icon-btn{padding:12px 16px;font-size:16px}
      /* 采用纵向铺满布局 */
      #content{display:flex;flex-direction:column;flex:1;min-height:0}
      .mobile-tabs{display:flex;position:sticky;top:0;z-index:5;background:var(--bg);padding-bottom:8px}
      .toolbar{position:static;padding:10px}
      /* 让卡片自己撑满 */
      .table-card,#chartsPanel{flex:1;min-height:0}
      .table-wrap{flex:1;max-height:none;min-height:0}
      .charts{flex:1;overflow:auto;-webkit-overflow-scrolling:touch}
      .chart-canvas{height:min(55vh,420px)}
      /* 沉浸模式：隐藏头部与控制区 */
      body.immersive .app-header, body.immersive .toolbar{display:none!important}
      .fab{display:inline-flex}

	#tableCard { display: none !important; }
  	.mobile-tabs { display: none !important; }

	/* 新增：移动端隐藏 R1、R2 两个图表卡片 */
  	#chartsPanel .chart-card:has(#r1Chart),
  	#chartsPanel .chart-card:has(#r2Chart) {
    	display: none !important;
    }
  </style>
</head>
<body>
  <div id="app">
    <header class="app-header">
      <div>
        <h1 class="title">Renesas BLE 100 ms Logger</h1>
        <p class="subtitle">exportable · calibration‑ready</p>
      </div>
      <div>
        <button id="themeToggle" class="icon-btn" aria-label="switch to dark mode" aria-pressed="false" title="switch to light/dark mode">🌙 <span class="label">Dark</span></button>
      </div>
    </header>

    <!-- Controls -->
    <section class="panel toolbar" aria-label="Controls">
      <div class="row">
        <button id="btn" class="btn">Connect &amp; Start Logging</button>
        <a id="dl" class="btn secondary" style="display:none;" aria-disabled="true">Download CSV</a>
      </div>
      <div class="row" role="group" aria-label="Calibration inputs">
        <div class="field">
          <label for="t25">R<sub>T</sub>@25 °C (Ω)</label>
          <input id="t25" class="input" type="number" step="any" placeholder="e.g. 30" />
        </div>
        <div class="field">
          <label for="t50">R<sub>T</sub>@50 °C (Ω)</label>
          <input id="t50" class="input" type="number" step="any" placeholder="e.g. 60" />
        </div>
        <div class="field">
          <label for="ph1">R<sub>pH</sub>@pH 1 (kΩ)</label>
          <input id="ph1" class="input" type="number" step="any" placeholder="e.g. 30" />
        </div>
        <div class="field">
          <label for="ph8">R<sub>pH</sub>@pH 8 (kΩ)</label>
          <input id="ph8" class="input" type="number" step="any" placeholder="e.g. 250" />
        </div>
      </div>
      <p class="hint">Enter all four calibration values to enable the button.</p>
    </section>

    <section id="content">
      <!-- Mobile tabs -->
      <nav class="mobile-tabs" role="tablist" aria-label="View Switching">
        <button class="btn secondary tab" data-target="#tableCard" role="tab" aria-selected="true">Table</button>
        <button class="btn secondary tab" data-target="#chartsPanel" role="tab" aria-selected="false">Chart</button>
      </nav>

      <!-- Table -->
      <div class="panel table-card" id="tableCard">
        <div class="table-head">
          <div class="subtitle" style="margin:0">Live Data</div>
        </div>
        <div class="table-wrap">
          <table id="log">
            <thead>
              <tr>
                <th class="sticky">#</th>
                <th>Time (ms)</th>
                <th>Raw Hex</th>
                <th>S1 (mV)</th>
                <th>S2 (mV)</th>
                <th>R1 (kΩ)</th>
                <th>R2 (Ω)</th>
                <th>Temp (°C)</th>
                <th>pH</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Charts -->
      <div class="panel charts" id="chartsPanel">
        <div class="chart-card">
          <div class="chart-title">R1 (kΩ)</div>
          <div class="chart-canvas"><canvas id="r1Chart"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="chart-title">R2 (Ω)</div>
          <div class="chart-canvas"><canvas id="r2Chart"></canvas></div>
        </div>
        <div class="chart-card">
          <div class="chart-title">pH</div>
          <div class="chart-canvas"><canvas id="phChart"></canvas></div>
        </div>
	<div class="chart-card">
          <div class="chart-title">Temperature (°C)</div>
          <div class="chart-canvas"><canvas id="tempChart"></canvas></div>
        </div>

      </div>
    </section>
  </div>

  <!-- 移动端浮动按钮：显示/隐藏控制区（沉浸式查看表格/图表） -->
  <button id="toggleControls" class="fab" aria-label="Toggle controls">⚙️</button>

<script>
/***** ---------- 主题切换 & 移动端标签 ---------- *****/
(function(){
  const KEY='theme';
  const root=document.documentElement;
  const btn=document.getElementById('themeToggle');
  const label=btn.querySelector('.label');
  const mql=window.matchMedia('(prefers-color-scheme: dark)');

  const saved=localStorage.getItem(KEY);
  const userSet = saved === 'light' || saved === 'dark';
  const init = saved || (mql.matches ? 'dark' : 'light');
  applyTheme(init, false);

  if(!userSet){
    mql.addEventListener('change', e=> applyTheme(e.matches? 'dark':'light', false));
  }

  btn.addEventListener('click', ()=>{
    const next = (getTheme()==='dark')? 'light':'dark';
    applyTheme(next, true);
  });

  function getTheme(){ return root.getAttribute('data-theme') || 'light'; }

  function applyTheme(theme, persist){
    root.setAttribute('data-theme', theme);
    const isDark = theme==='dark';
    btn.setAttribute('aria-pressed', String(isDark));
    btn.setAttribute('aria-label', isDark? 'switch to light mode':'switch to dark mode');
    btn.title = 'switch to light/dark mode';
    btn.firstChild.nodeValue = isDark? '☀️ ':'🌙 ';
    label.textContent = isDark? 'Light':'Dark';
    if(persist){ localStorage.setItem(KEY, theme); }
    updateChartColors();
  }

  // 移动端“表格/图表”标签切换
  const tabs = document.querySelectorAll('.mobile-tabs .tab');
  const table = document.getElementById('tableCard');
  const charts = document.getElementById('chartsPanel');

  function setActive(targetSel){
    const isCharts = targetSel === '#chartsPanel';
    tabs.forEach(t=> t.setAttribute('aria-selected', String(t.dataset.target===targetSel)) );
    if(window.matchMedia('(max-width:640px)').matches){
      (isCharts? table: charts).classList.add('is-hidden-mobile');
      (isCharts? charts: table).classList.remove('is-hidden-mobile');
      // 进入图表页后，主动触发尺寸更新，避免隐藏->显示后尺寸计算不准
      if(isCharts){ [chartR1,chartR2,chartTemp,chartPH].forEach(ch=>ch&&ch.resize()); }
      window.scrollTo({top:0,behavior:'instant'});
    }else{
      table.classList.remove('is-hidden-mobile');
      charts.classList.remove('is-hidden-mobile');
    }
  }

  tabs.forEach(t=> t.addEventListener('click', ()=> setActive(t.dataset.target)) );

  function handleResize(){
    if(window.matchMedia('(max-width:640px)').matches){
      // 默认展示表格
      setActive('#tableCard');
    }else{
      table.classList.remove('is-hidden-mobile');
      charts.classList.remove('is-hidden-mobile');
    }
  }
  handleResize();
  window.addEventListener('resize', handleResize);
})();

/***** ---------- Config ---------- *****/
const SERVICE_UUID='00001800-0000-1000-8000-00805f9b34fb';
const CHAR_UUID   ='00002a00-0000-1000-8000-00805f9b34fb';
const PERIOD_MS   =100;
const DEVICE_NAME ='This_is_renesas😎';
const VCC_SENS=2897;
const R01=15;      // kΩ divider ref for S1 path
const R02=820;     // Ω  divider ref for S2 path
const R1 =75;      // kΩ stray/other path (legacy constant used in calc)
const MAX_POINTS=600; // chart tail length => 60 s at 100 ms/sample

/***** ---------- State ---------- *****/
let device,char,rowCount=0,startMs=0,nextT=0;
let csv='Index,Time(ms),RawHex,S1(mV),S2(mV),R_S1(kΩ),R_S2(Ω),Temp(°C),pH\n';
let chartR1,chartR2,chartTemp,chartPH;

/***** ---------- Elements ---------- *****/
const btn=document.getElementById('btn');
const dl=document.getElementById('dl');
const tbody=document.querySelector('#log tbody');
// calibration inputs
const inT25=document.getElementById('t25');
const inT50=document.getElementById('t50');
const inPH1=document.getElementById('ph1');
const inPH8=document.getElementById('ph8');
const fab=document.getElementById('toggleControls');

/***** ---------- Input Validation ---------- *****/
function validateInputs(){
  // 所有输入需为数字
  const filled=[inT25,inT50,inPH1,inPH8].every(el=>isFinite(parseFloat(el.value)));
  btn.disabled=!filled;
}
[inT25,inT50,inPH1,inPH8].forEach(el=>el.addEventListener('input',validateInputs));
validateInputs();

/***** ---------- 校准换算 ---------- *****/
function getCal(){
  const RT25=parseFloat(inT25.value);
  const RT50=parseFloat(inT50.value);
  const RP1 =parseFloat(inPH1.value); // kΩ
  const RP8 =parseFloat(inPH8.value); // kΩ

  let mT,bT; // Temp = mT*R2 + bT (R2 in Ω)
  if(isFinite(RT25) && isFinite(RT50) && RT25!==RT50){
    mT=(50-25)/(RT50-RT25);
    bT=25 - mT*RT25;
  }else{ mT=NaN; bT=NaN; }

  let mPH,bPH; // pH = mPH*R1 + bPH (R1 in kΩ)
  if(isFinite(RP1) && isFinite(RP8) && RP1!==RP8){
    mPH=(8-1)/(RP8-RP1);
    bPH=1 - mPH*RP1;
  }else{ mPH=NaN; bPH=NaN; }
  return {mT,bT,mPH,bPH};
}

function r2ToTemp(r2){
  const {mT,bT}=getCal();
  if(!isFinite(mT))return NaN;
  return mT*r2 + bT;
}
function r1ToPH(r1){
  const {mPH,bPH}=getCal();
  if(!isFinite(mPH))return NaN;
  return mPH*r1 + bPH;
}

/***** ---------- Charts ---------- *****/
function initCharts(){
  const styles=getComputedStyle(document.documentElement);
  const c1=styles.getPropertyValue('--series1').trim()||'#2563eb';
  const c2=styles.getPropertyValue('--series2').trim()||'#ef4444';
  const c3=styles.getPropertyValue('--series3').trim()||'#10b981';
  const c4=styles.getPropertyValue('--series4').trim()||'#8b5cf6';
  const grid=styles.getPropertyValue('--grid').trim()||'rgba(0,0,0,.06)';

  const common={
    type:'line',
    options:{
      responsive:true,maintainAspectRatio:false,animation:false,tension:.3,
      plugins:{legend:{display:false}},
      scales:{
        x:{title:{display:true,text:'t (s)'},grid:{display:false},ticks:{maxTicksLimit:10}},
        y:{beginAtZero:false,grid:{color:grid}}
      }
    }
  };

  chartR1=new Chart(document.getElementById('r1Chart'),{
    ...common,
    data:{labels:[],datasets:[{data:[],borderColor:c1,borderWidth:2,pointRadius:0}]},
    options:{...common.options,scales:{...common.options.scales,y:{min:0,max:500,grid:{color:grid}}}}
  });
  chartR2=new Chart(document.getElementById('r2Chart'),{
    ...common,
    data:{labels:[],datasets:[{data:[],borderColor:c2,borderWidth:2,pointRadius:0}]},
    options:{...common.options,scales:{...common.options.scales,y:{min:0,max:100,grid:{color:grid}}}}
  });
  chartTemp=new Chart(document.getElementById('tempChart'),{
    ...common,
    data:{labels:[],datasets:[{data:[],borderColor:c3,borderWidth:2,pointRadius:0}]},
    options:{...common.options,scales:{...common.options.scales,y:{min:10,max:60,grid:{color:grid}}}}
  });
  chartPH=new Chart(document.getElementById('phChart'),{
    ...common,
    data:{labels:[],datasets:[{data:[],borderColor:c4,borderWidth:2,pointRadius:0}]},
    options:{...common.options,scales:{...common.options.scales,y:{min:0,max:14,grid:{color:grid}}}}
  });
}

function updateChartColors(){
  if(!(window.chartR1||window.chartR2||window.chartTemp||window.chartPH)) return;
  const styles=getComputedStyle(document.documentElement);
  const grid=styles.getPropertyValue('--grid').trim();
  const c1=styles.getPropertyValue('--series1').trim();
  const c2=styles.getPropertyValue('--series2').trim();
  const c3=styles.getPropertyValue('--series3').trim();
  const c4=styles.getPropertyValue('--series4').trim();
  const charts=[chartR1,chartR2,chartTemp,chartPH];
  const colors=[c1,c2,c3,c4];
  charts.forEach((ch,i)=>{
    if(!ch) return;
    ch.data.datasets[0].borderColor = colors[i];
    if(ch.options && ch.options.scales && ch.options.scales.y){
      ch.options.scales.y.grid.color = grid;
    }
    ch.update('none');
  });
}

function pushData(chart,label,val){
  chart.data.labels.push(label);
  chart.data.datasets[0].data.push(val);
  if(chart.data.labels.length>MAX_POINTS){
    chart.data.labels.shift();
    chart.data.datasets[0].data.shift();
  }
  chart.update();
}

/***** ---------- BLE + Logging ---------- *****/
btn.onclick=async()=>{
  // double-check in case somehow enabled without filled inputs
  if(btn.disabled) return;
  try{
    device=await navigator.bluetooth.requestDevice({filters:[{name:DEVICE_NAME}],optionalServices:[SERVICE_UUID]});
    const server=await device.gatt.connect();
    const service=await server.getPrimaryService(SERVICE_UUID);
    char=await service.getCharacteristic(CHAR_UUID);

    startMs=performance.now();
    nextT=startMs+PERIOD_MS;
    initCharts();
    updateChartColors(); // 创建后立即按当前主题同步配色
    readLoop();
    btn.disabled = true; // keep disabled once logging starts

    // 移动端自动进入沉浸模式：把空间让给表格/图表
    if(window.matchMedia('(max-width:640px)').matches){
      document.body.classList.add('immersive');
    }
  }catch(e){
    alert('BLE connection error: '+e);
  }
};

// 浮动按钮：切换沉浸模式，便于随时找回控制区
fab.addEventListener('click',()=>{
  document.body.classList.toggle('immersive');
  // 切换可见性后触发图表尺寸更新
  setTimeout(()=>[chartR1,chartR2,chartTemp,chartPH].forEach(ch=>ch&&ch.resize()),50);
});

async function readLoop(){
  try{
    const value=await char.readValue();
    logSample(value);
  }catch(e){console.warn('Read failed',e);}  
  nextT+=PERIOD_MS;
  setTimeout(readLoop,Math.max(0,nextT-performance.now()));
}

function logSample(dataView){
  const bytes=new Uint8Array(dataView.buffer);
  const rawHex='0x'+[...bytes].map(b=>b.toString(16).padStart(2,'0')).join('');
  const s2_mV=bytes[1]*100+bytes[2];
  const s1_mV=bytes[3]*100+bytes[4];
  const r_s1_kOhm=1/(((VCC_SENS/s1_mV)-1)/R01-1/R1);
  const r_s2_Ohm =R02/(VCC_SENS/s2_mV-1);

  const temp=r2ToTemp(r_s2_Ohm);          // °C
  const ph  =r1ToPH(r_s1_kOhm);           // pH units

  const r1_disp=r_s1_kOhm.toFixed(2);
  const r2_disp=r_s2_Ohm.toFixed(2);
  const temp_disp=isFinite(temp)?temp.toFixed(2):'';
  const ph_disp=isFinite(ph)?ph.toFixed(2):'';

  const t =Math.round(performance.now()-startMs);
  const tLabel=(t/1000).toFixed(2);

  // table row
  addRow([rowCount+1,t,rawHex,s1_mV,s2_mV,r1_disp,r2_disp,temp_disp,ph_disp]);
  rowCount++;

  // charts (raw R1/R2 always plotted; Temp/pH only if valid cal)
  pushData(chartR1,tLabel,r_s1_kOhm);
  pushData(chartR2,tLabel,r_s2_Ohm);
  pushData(chartTemp,tLabel,isFinite(temp)?temp:null);
  pushData(chartPH,tLabel,isFinite(ph)?ph:null);

  // csv
  csv+=`${rowCount},${t},${rawHex},${s1_mV},${s2_mV},${r1_disp},${r2_disp},${temp_disp},${ph_disp}\n`;
  if(rowCount%100===0)updateDownloadLink();
}

function addRow(cells){
  const tr=document.createElement('tr');
  const classes=['num','num','mono','num','num','num','num','num','num'];
  cells.forEach((text,i)=>{
    const td=document.createElement('td');
    td.textContent=text;
    if(i===0){td.classList.add('sticky','num');}
    if(classes[i]) td.classList.add(classes[i]);
    tr.appendChild(td);
  });
  tbody.appendChild(tr);
}

function updateDownloadLink(){
  const blob=new Blob([csv],{type:'text/csv'});
  dl.href=URL.createObjectURL(blob);
  dl.download='ble_log.csv';
  dl.style.display='inline-block';
  dl.removeAttribute('aria-disabled');
}
</script>
</body>
</html>
